<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
        "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en" >

<head>
    <meta charset="utf-8">
    <link rel="stylesheet"
          type="text/css"
          href="./jquery.ganttView.css"/>
    <link href="./lib/jquery-ui.min.css"
          rel="stylesheet">
    <script src="./lib/my.js"></script>
    <script src="./lib/jquery.min.js"></script>
    <script src="./lib/jquery-ui.min.js"></script>
    <script src="./lib/vue.js"></script>
    <script src="./lib/moment.min.js"></script>
    <script type="text/javascript" src="data1.js"></script>

    <link href="./lib/select2.min.css" rel="stylesheet" />

    <script src="./lib/select2.min.js"></script>
    <style type="text/css">
        body {
            font-family: tahoma, verdana, helvetica;
            font-size: 0.8em;
            padding: 10px;
            height:100%;
        }
        html{
            height:100%;
        }
    </style>
    <title>Vue and jQuery Gantt</title>
</head>

<body  >
<div id="ganttChart" >
    <div class="ganttview" >

        <div class="ganttview-vtheader">
            <!--
            <div class="ganttview-vtheader-content">
            <table class="ganttview-vtheader-item">
                <thead>

                <th v-for="col in layout.tableDataType" v-if="col.hidden!=true" class="ganttview-vtheader-title ganttview-vtheader-title-name" :style="{height:props.headerHeight+'px'}">
                    {{ col.label}}
                </th>

                </thead>
                <tbody >
                    <tr v-for="row in layout.tableData" class="ganttview-vtheader-series" :id="row.attr.id" :_key="row.attr.key">
                        <td v-for="col in layout.tableDataType" v-if="col.hidden!=true" class="ganttview-vtheader-series-name">
                            {{row[col.name]}}

                        </td>
                    </tr>
                </tbody>
            </table>
            </div>
            -->
        </div>
        <div class="ganttview-main">
            <!--
            <div class="ganttview-hint">
                <div class="ganttview-hint-content">
                    this is hint
                </div>
            </div>

            <div class="ganttview-slide">
                <div class="ganttview-slide-container">
                <div class="ganttview-hzheader"
                     :style="{width:(hzheaderTotalWidth() )+'px'}">
                    <div class="ganttview-hzheader-months">
                        <div class="ganttview-hzheader-month"
                             v-for="(i,index) in dateDiff()"
                             :style="{width:getHzHeaderMonthWith(props.start.clone().add(index,'d'))+'px'}">{{i}}
                        </div>
                    </div>
                    <div class="ganttview-hzheader-days">
                        <div class="ganttview-hzheader-day"
                             v-for="i in hourList()">{{i}}
                        </div>
                    </div>
                </div>

                <div style="clear: both;"></div>

                <div class="ganttview-grid"
                     :style="{width:(hzheaderTotalWidth() )+'px'}">
                    <div class="ganttview-grid-row"
                         v-for="(item,ridx) in this.layout.tableData.length"
                         :id="gridRowId(ridx)">
                        <div class="ganttview-grid-row-cell"
                             :class="[i==0?'ganttview-weekend':'']"
                             v-for="(i,cidx) in hourList()" :id="gridColId(ridx,cidx)"></div>
                    </div>
                </div>

                <div class="ganttview-blocks" >
                    <div class="arrow"></div>
                    <div class="arrow-hints">time hints</div>
                    <div class="ganttview-block-hint"></div>
                    <div class="ganttview-block-hint-start"></div>
                    <div class="ganttview-block-hint-end"></div>

                </div>

                </div>

            </div>
            -->
        </div>
        <div class="ganttview-navigate" >
            <select id="barSelector" name="barSelector" class="nav-select"   type="text"></select>
            <button type="button" id='btnNew' class="nav-button nav-new" title="新增">n</button>
            <button type="button" id='btnDelete' class="nav-button nav-delete" title="删除">d</button>
            <button type="button" id='btnSplit' class="nav-button nav-split" title="分割">s</button>
            <button type="button" id='btnMerge' class="nav-button nav-merge" title="合并">m</button>
            <button type="button" id='btnZoomOut' class="nav-button nav-zoomOut" title="缩小">o</button>
            <button type="button" id='btnZoomIn' class="nav-button nav-zoomIn" title="放大">i</button>
            <button type="checkbox" id='btnMulti' class="nav-button nav-multi unselected"  title="单选">c</button>
            <button type="button" id='btnMagnet' class="nav-button nav-magnet selected"  title="吸附">c</button>
            <button type="button" id='btnPrev' class="nav-button nav-prev "  title="时间向前延展">p</button>
            <button type="button" id='btnNext' class="nav-button nav-next "  title="时间向后延展">n</button>

        </div>


    </div>


    <br/>
    <div>{{eventMessage}}</div>
</div>
<br/>
<br/>

<script>
    //配置
    const defaults = {
        cellWidth: 21,
        cellHeight: 32, //border
        rowHeight: 30, //每行与背景cellHeight存在一个padding
        barHeight: 25,
        headerHeight:41,
        viewTopMargin:0,// bar的VIEW区上边距，view为grid，不包含header区
        showDragHints:1,//拖动时显示时间提示
        extendTimes:6, //时间向前延展步长
        start: moment().subtract(3,'d'),
        end: moment().add(3, 'd').add(1, 's')
        ,canDrag( barid ){
            if( barid == 'bar_ay3_001'){
                return false;
            }
            return true;
        }
        ,canMagnetBar(barid1 , barid2){
            return true;
        }
        ,canResize( barid ){
            if( barid == 'bar_ay3_002'){
                return false;
            }
            return true;
        }
        ,canChangeDataByManual( dataId){
            return true;
        }
        ,canDeleteBar(barid){
            return true;
        }
        ,canDeleteData(data){
            return true;
        }
        ,canNewBar(data){
            return true;
        }
        ,canSplitBar(barid,data1,data2){
            return true;
        }
        ,newData(){
            return NaN;
        }

        ,getSplitDatas(barid,data){
            //返回分割后的两个新数据,注意完成进度 progress 的分割，一般以分割点占时间线的百分比来确定
            // let bar = jQuery("#"+barid);
            // let width = parseInt( bar.css("width") );
            // let progress = data.progress;
            // let splitDate;
            // let x = moment(data.start).diff(moment(splitDate),'h',true)*this.cellWidth;
            // let scale = getNumber(x/width,2);
            // let pg1 = getNumber(scale*progress,2);
            // if (pg1>100){
            //     pg1 = 100;
            // }
            // let pg2 = progress-pg1;

            return [];
        }
        ,afterSplitBar(data1,data2){

        }
        ,canMergeBar(barid1 , barid2){
            return true;
        }
        ,afterMergeBar(newData){

        }

        ,onViewClick:function(obj,event){
            console.log("view click args:"+arguments.length+" x:"+event.offsetX+" y:"+event.offsetY);
            console.log(" datas:"+JSON.stringify(gantt.datas));

        }

        ,onActiveBar(barid){
            let barsid = gantt.getSelectedBarsId();
            let text="Selected Count: "+barsid.length+"<br/>";
            let bar , data;
            barsid.forEach(function(bid,index){


                 bar = jQuery("#"+bid);
                 data = gantt.getDataByBarId(bid);
                text = text+"---------------<br/><br/>";
                text = text+"[ ROW:"+bar.attr("row")+" ]<br/><br/>";

                 text = text+"&nbsp;&nbsp;BarID:"+bid+"<br/><br/>";
                text = text+"&nbsp;&nbsp;Name:"+data.name+"<br/><br/>";
                text = text+"&nbsp;&nbsp;Key:"+data.key+"<br/><br/>";
                text = text+"&nbsp;&nbsp;StartDate:"+data.start.format("YYYY-MM-DD HH:mm")+"<br/><br/>";
                text = text+"&nbsp;&nbsp;EndDate:"+data.end.format("YYYY-MM-DD HH:mm")+"<br/><br/>";
            });
            jQuery(".ganttview-hint-content").html(text);


        }
        ,onItemClick:function(barid){
            var data = gantt.getDataByBarId(barid);
            console.log("bar.click barid:"+barid+' data:'+JSON.stringify(data) +' nextBars:'+gantt.getNextBarsJQuery(barid)+" preBars:"+gantt.getPreBarsJQuery(barid));
            alert(JSON.stringify(data));
        }
        ,onItemStartDrag:function(barid,startPos,endPos,arrowX,arrowY){ return; }
        ,onItemEndDrag:function(barid,startPos,endPos,arrowDate){

            var data = gantt.getDataByBarId(barid);
            console.log("bar.dragend barid:"+barid+' arrowDate:'+ moment(arrowDate).format('YYYY-MM-DD HH:mm')+' data:'+JSON.stringify(data) +' nextBars:'+gantt.getNextBarsJQuery(barid)+" preBars:"+gantt.getPreBarsJQuery(barid));

        }
        ,onItemDrag:function( barid , startPos , endPos,arrowDate){ this.onActiveBar(barid) }
        ,onItemStartResize:function(barid,startPos,endPos){
            var data = gantt.getDataByBarId(barid);
            // console.log("start resize barid:"+barid+" startpos:"+JSON.stringify(startPos)+" endPos:"+JSON.stringify(endPos));
        }
        ,onItemEndResize:function(barid,startPos,endPos){
            var data = gantt.getDataByBarId(barid);
            // console.log(" resize end barid:"+barid+" startpos:"+JSON.stringify(startPos)+" endPos:"+JSON.stringify(endPos));
        }
        ,onItemResize:function(barid,startPos,endPos){
            var data = gantt.getDataByBarId(barid);

            this.onActiveBar(barid);
            // console.log(" resize barid:"+barid+" startpos:"+JSON.stringify(startPos)+" endPos:"+JSON.stringify(endPos));
        }
        ,getBarHints(dataid,data,barid, isDrag, rownum, date) {

            let bar = $("#"+barid);
            let row = bar.attr("row");
            return "row:"+row+" "+data.name+": "+moment(data.start).format("YYYY-MM-DD HH:mm")+" TO "+ moment(data.end).format("YYYY-MM-DD HH:mm");
        }
        ,onButtonClick(btnId){
            alert( btnId);
        }


    };
    var gantt = new Vue({
        //el: '#ganttChart',
        data: {
            layout:ganttLayout,
            datas: ganttData,
            props: defaults,
            hitBlock: false,
            eventMessage: ""
        },
        computed: {

            allRow() {
                let temp = [];

                for(let item of this.datas) {
                    for (let row of this.layout.tableData) {
                        if(item.key === row.attr.key){
                            temp.push(item);

                        }
                    }
                }
                return temp;
            }

        },
        watch: {
            //数据变动时重新绑定
             datas() {
                 this.$nextTick(() => {
                     this.bindBarSelect()
                 })
             },
            hitBlock() {
                this.$nextTick(() => {
                    this.initBind()
                })
            }

        },
        created() {
        },
        mounted() {
            //初始绑定
            this.initBind()
        },
        methods: {
            //天列表
            dateDiff() {
                let temp = [];
                let start = this.props.start.clone();
                let end = this.props.end.format("MM/DD")
                for (; start.format("MM/DD") != end; start.add(1, 'd')) {
                    temp.push(start.format("MM/DD"))
                }
                temp.push(start.format("MM/DD"))
                return temp;
            },
            //小时列表
            hourList() {
                let temp = [];
                let start = this.props.start.clone()
                let end = this.props.end.clone()
                while (start.isBefore(end)) {
                    temp.push(start.hour());
                    start.add(1, 'h');
                }
                //temp.push(start.hour());
                return temp;
            }
            //其中1代表后各加一个小时
            ,hzheaderTotalWidth() {
                return ((this.props.end.diff(this.props.start,
                    'h') + 1) * this.props.cellWidth)
            }
            ,getNumber(num , perc){
                if(arguments.length==1){
                    return parseInt(num);
                }
                if(arguments.length==2){
                    return Math.round(num*Math.pow(10,perc))/Math.pow(10,perc);
                }
                return NaN;

            }
            ,getSelectedBarsId(){
                let bars=[];
                let self = this;
                jQuery(".ganttview-block").each(function (item , index){
                    let bar = jQuery(this);
                    if(bar.hasClass("ganttview-block-active")){
                        bars.push(self.getDataByBarId(bar.attr("id")));
                    }
                });
                bars = bars.sort( compare("start"),"asc");
                let barids = [];
                bars.forEach(function(bar,index){
                    barids.push(self.barId( bar.id) );
                });
                return barids;
            }
            ,getDragTime(barid,startPos,endPos,arrowX,arrowY){
                //view的开始日期
                let data = this.getDataByBarId(barid);
                //每个col的宽度
                let cellWidth = this.props.cellWidth;
                let tt = this.getNumber( parseInt( arrowX) /cellWidth);
                let cols = this.getNumber( parseInt( arrowX) /cellWidth,2);

                let time = moment(data.start.valueOf()).add(tt , 'hours').add( (cols-tt)*60,'minutes');
                return time;
            }
            ,resizeBarDate( barid , fromPos , toPos,leftOrRight){
                let data = this.getDataByBarId(barid);
                let cellWidth = this.props.cellWidth;
                let isright = 0;
                let x =   parseInt( toPos.x ) - parseInt( fromPos.x);
                if(leftOrRight==2 || leftOrRight=='R' || leftOrRight=="right" || leftOrRight=='r' || leftOrRight=='e') {
                    isright = 1;
                }
                if(isright==1){
                    x =   parseInt( toPos.w ) - parseInt( fromPos.w);
                }

                let tt = this.getNumber( x/cellWidth);
                let cols = this.getNumber( x/cellWidth,2);
                let stime , dtime;

                if(isright == 0 ){
                     stime = moment(data._original.start).add(tt  , 'hours').add((cols-tt)*60,'minutes');
                     data.start = stime;
                }
                if(isright==1){

                    dtime = moment(data._original.end).add(tt , 'hours').add((cols-tt)*60,'minutes');
                    data.end = dtime;
                }
            }
            ,dragBarDate(barid,startPos,dragPos){
                let data = this.getDataByBarId(barid);
                let x =   parseInt( dragPos.x ) - parseInt( startPos.x);
                //每个col的宽度
                let cellWidth = this.props.cellWidth;

                let tt = this.getNumber( x/cellWidth);
                let cols = this.getNumber( x/cellWidth,2);

                let stime = moment(data._original.start.valueOf()).add(tt  , 'hours').add((cols-tt)*60,'minutes');
                let dtime = moment(data._original.end.valueOf()).add(tt , 'hours').add((cols-tt)*60,'minutes');
                data.start = stime;
                data.end = dtime;

            }
            ,getKeyOfRow(rowNumber){
                let rows=this.layout.tableData.length;
                if(rowNumber<0 && rowNumber>=rows){
                    return NaN;
                }


                return this.layout.tableData[rowNumber].attr["key"];


            }

            ,getBarHints(barid,isDrag,rownum,date){
                let barData = this.getDataByBarId(barid);
                let dataId = this.getDataIdByBarId(barid);
                return this.props.getBarHints(dataId,barData,barid,isDrag,rownum,date);
            }
            ,updateBarHints(barid){
                let txt = this.getBarHints(barid);
                let hint = jQuery(".ganttview-block-hint");
               hint.text(txt);
            }

            ,updateBarStartHints(barid){
                let data = this.getDataByBarId(barid);
                let hint = jQuery(".ganttview-block-hint-start");
                hint.text(data.start.format("YYYY-MM-DD HH:mm"));
            }

            ,updateBarEndHints(barid){
                let data = this.getDataByBarId(barid);
                let hint = jQuery(".ganttview-block-hint-end");
                hint.text(data.end.format("YYYY-MM-DD HH:mm"));
            }
            ,makeNewData(key){
                let data = {};
                data.key = key;
                data.series=[];
                data.id = Math.random();
                data.name='';
                return data;

            }
            ,magnetBars( barid1 , barid2){

                if(!barid1 || !barid2){
                    return;
                }
                let data1 , data2;
                data1 = this.getDataByBarId(barid1);
                data2 = this.getDataByBarId(barid2);
                if(!data1 || !data2 || !data1.id || !data2.id){
                    return;
                }
                if(data1.key !=data2.key){
                    return;
                }
                let r1 = this.getRowOfData(data1);
                let r2 = this.getRowOfData(data2);
                if(r1!=r2){
                    return;
                }

                if( ! this.props.canMagnetBar(barid1,barid2)){
                    return;
                }
                console.log("magnetBars");
                let  dd2;
                let newData = this.cloneData(data2);
                dd2 = data2.start.diff(data1.end,'h',true);
                newData.start = data2.start.clone().subtract(dd2,'h');
                newData.end = data2.end.clone().subtract(dd2,'h');
                this.changeBarByManual(newData);

            }
            ,deleteBar(barid){
                if (!this.props.canDeleteBar(barid)){
                    return;
                }
                let did = this.getDataIdByBarId(barid);
                if(!did || (typeof did )=='undefined'){
                    return;
                }
                console.log("delete bar:"+barid)
                let data;
                jQuery("#"+barid).remove();
                for(let i = 0 ; i < this.datas.length; i++){
                    for(let j = 0 ; j <this.datas[i].series.length ; j++){
                        if(this.datas[i].series[j].id == did ){
                            // console.log("moveData find:"+data.id+ "  "+data.key);
                            data=this.datas[i].series.splice(j,1);
                            break;
                        }
                    }
                }
                return data;
            }
            ,deleteData(dataid){

                let data;
                let i , j;
                for( i = 0 ; i < this.datas.length; i++){
                    for( j = 0 ; j <this.datas[i].series.length ; j++){
                        if(this.datas[i].series[j].id == did ){
                            // console.log("moveData find:"+data.id+ "  "+data.key);
                            if (this.props.canDeleteData(this.datas[i].series[j])){
                                data=this.datas[i].series.splice(j,1);
                            }
                            break;
                        }
                    }
                }
                if(data){
                    let barid=this.barId(dataid);
                    jQuery(".ganttview-blocks").remove("#"+barid);
                }
                return data;

            }
            ,splitBar(barid,newData1,newData2){
                if(!newData1 || !newData2){
                    return;
                }
                if (!newData1.start || !newData1.end
                    || !newData2.start || !newData2.end ){
                    return;
                }
                if (moment(newData1.end).diff(moment(newData2.start),'h',true) != 0 ){
                    return;
                }
                let data = this.getDataByBarId(barid);
                if(!data){
                    return;
                }
                if(data.key !=newData1.key || data.key != newData2.key){
                    return;
                }
                if(data.id == newData1.id || data.id == newData2.id){
                    return;
                }
                if(!this.canSplitBar(barid,newData1,newData2)){
                    return;
                }
                this.deleteData(data.id);
                this.insertData(newData1);
                this.insertData(newData2);
                this.afterSplitBar(newData1 , newData2);
                return [newData1,newData2];
            }
            ,cloneData(data){
                let txt = JSON.stringify(data);
                let obj =  JSON.parse(txt);
                obj.start = moment(obj.start);
                obj.end = moment(obj.end);
                return obj;
            }
            ,mergeBar(barid1 , barid2){
                if(!barid1 || !barid2){
                    return;
                }
                let data1 , data2;
                data1 = this.getDataByBarId(barid1);
                data2 = this.getDataByBarId(barid2);
                if(!data1 || !data2 || !data1.id || !data2.id){
                    return;
                }
                if(data1.key !=data2.key){
                    return;
                }
                if( ! this.props.canMergeBar(barid1,barid2)){
                    return;
                }
                let st1 , ed1 , pg,dd1,dd2;

                st = data1.start;
                ed = data1.end;
                if(st > data2.start){
                    st = data2.start;
                }
                if(ed<data2.end){
                    ed =data2.end;
                }
                dd1 = data1.end.diff(data1.start,'h',true);
                dd2 = data2.end.diff(data2.start,'h',true);
                ed = data1.end.clone().add(dd2,'h')


                pg = this.getNumber( ( ((data1.progress || 0)+(data2.progress ||0) ) /200 )*100 ,2);
                data1.start = st;
                data1.end = ed;
                data1.progress = pg;
                this.deleteBar(barid2);
                this.changeBarByManual(data1);
                this.props.afterMergeBar(data1);
                return data1;

            }


            ,insertData(data){
                let ke = data.key;
                let fnd = 0;
                for(let i = 0 ; i < rows ; i++){
                    if(this.datas[i].key == ke){
                        data.key = ke;
                        this.datas[i].series.push(data);
                        fnd = 1;
                    }
                }
                if(fnd == 0){
                    let dt = this.makeNewData(ke);
                    dt.series.push(data);
                    this.datas.push(dt);
                }
                let barid = this.barId(data.id);
                let bar = jQuery("."+barid);
                if(bar && (typeof bar)!='undefined'){
                    return;
                }
                let dhtml = this.htmlBlockData(data);
                jQuery(".ganttview-blocks").append(dhtml);

            }
            ,moveDataByKey(data, key){
                let ke = key;
                if (!ke){
                    ke=data.key;
                }
                if(!ke || typeof ke == 'undefined'){
                    throw 'key undefined';
                }
                let rows=this.datas.length;


                // console.log("beforeMove:"+JSON.stringify(this.datas));

                for(let i = 0 ; i < rows ; i++){
                    for(let j = 0 ; j <this.datas[i].series.length ; j++){
                        // console.log("moveData i:"+i+ " j:"+j+" id:"+this.datas[i].series[j].id);
                        if(this.datas[i].series[j].id == data.id ){
                            // console.log("moveData find:"+data.id+ "  "+data.key);
                            this.datas[i].series.splice(j,1);
                            break;
                        }
                    }
                }
                let fnd = 0;
                for(let i = 0 ; i < rows ; i++){
                    if(this.datas[i].key == ke){
                        data.key = ke;
                        this.datas[i].series.push(data);
                        fnd = 1;
                    }
                }
                if(fnd == 0){
                    let dt = this.makeNewData(ke);
                    dt.series.push(data);
                    this.datas.push(dt);
                }

                // console.log("afterMove:"+JSON.stringify(this.datas));


            }
            ,changeBarByManual(newData){
                //仅实现 开始日期， 结束日期， key
                if(!newData.id){
                    return;
                }
                let barid = this.barId( newData.id );
                let data = this.getDataByBarId(barid);
                if(!data){
                    return;
                }
                let h_step , m_step , step=0;
                let bar = jQuery("#"+barid);


                if(newData.start){

                    h_step =  moment(newData.start).diff(data.start, 'h', true) * this.props.cellWidth
                    //m_step =  this.getNumber( moment(newData.start).diff(data.start, 'minutes', true)/60 , 2 ) * this.props.cellWidth
                    step = h_step ;
                    data.start = newData.start;
                }

                if(step != 0){
                    bar.css("left",parseInt(bar.css("left"))+step+'px');
                }

                step = 0;

                if(newData.end){
                    h_step =  moment(newData.end).diff(newData.start, 'h', true) * this.props.cellWidth
                   // m_step =  getNumber( moment(newData.end).diff(data.end, 'minutes', true)/60 , 2 ) * this.props.cellWidth
                    step = h_step;
                    data.end = newData.end;
                }


                if(step != 0){
                    bar.css("width", step+'px');
                }
                if( newData.key){
                    let ridx = this.getRowOfData(newData)
                    if(!ridx || (typeof ridx )=='undefined'){
                        return;
                    }
                    let curR = bar.attr("row");
                    if(ridx!=curR) {
                        bar.attr("row", ridx);
                        let key = gantt.getKeyOfRow( ridx );

                        bar.attr("_key", key);
                        bar.css("top",( gantt.props.cellHeight*ridx) + 'px');
                        data.key = key;
                        this.moveDataByKey(data , key);

                    }

                }

                let complete = (newData.progress || 0);
                if (complete>100){
                    complete = 100;
                }
                if(complete<0){
                    complete = 0;
                }

                let progress = jQuery("#"+barid+" .ganttview-block-progress");
                progress.css("width",complete+'%');
                progress.text(complete+"%");
                data.progress =complete;
                if ( complete>=100){
                    bar.addClass("ganttview-block-freeze");
                }
                else{
                    bar.removeClass("ganttview-block-freeze");
                }



            }
            ,deactiveAllBars(){
                this.props.selectstatus='single';
                jQuery("#btnMulti").removeClass("selected");
                jQuery("#btnMulti").addClass("unselected");
                jQuery(".ganttview-block-active").each(function (item, element) {
                        jQuery(this).removeClass("ganttview-block-active");
                        jQuery(this).addClass("ganttview-block-deactive");
                });
            }
            ,focusBar( barid ){
                let bar = jQuery("#"+barid);
                let container = jQuery(".ganttview-slide-container");
                container.scrollLeft((bar.offset().left - (bar.width()/2)) - container.offset().left+ container.scrollLeft() );
            }
            ,activeBar(barid){
                let bar = jQuery("#"+barid);
                let status = (this.props.selectstatus || 'single' );

                bar.removeClass("ganttview-block-deactive");

                if( bar.hasClass("ganttview-block-active")){
                    if(status =='multi'){
                        bar.removeClass("ganttview-block-active");
                        bar.addClass("ganttview-block-deactive");

                        this.props.onActiveBar(barid);
                    }
                    return;
                }
                if( status == 'single') {
                    jQuery(".ganttview-block-active").each(function (item, element) {
                        if (barid != jQuery(this).attr("id")) {
                            jQuery(this).removeClass("ganttview-block-active");
                            jQuery(this).addClass("ganttview-block-deactive");
                        }

                    });
                }
                else{

                    jQuery(this).removeClass("ganttview-block-deactive");
                }

                bar.addClass("ganttview-block-active");
                this.props.onActiveBar(barid);
            }
            ,topBar(barid){
                let bars = this.getBarsInRow(this.getRowNumberOfBar(barid));

                let bar = jQuery("#"+barid);
                let maxZ=bar.css("z-index");
                let z = maxZ;

                bars.forEach(function(item,idx){
                    if(item.css("z-index")>maxZ){
                        maxZ = item.css("z-index");
                    }
                });
                maxZ=parseInt(maxZ)+1;

                bar.css("z-index",maxZ);
            }
            , bottomBar(barid){
                let bars = this.getBarsInRow(this.getRowNumberOfBar(barid));
                let bar = jQuery("#"+barid);
                let minZ=bar.css("z-index");
                bars.forEach(function(item,idx){
                    if(item.css("z-index")<minZ){
                        minZ = item.css("z-index");
                    }
                });
                minZ=parseInt(minZ)-1;

                bar.css("z-index",minZ);
            }
            ,rowInXY(barId,x,y){
                let topMargin = this.props.viewTopMargin || 0;
                let bar = jQuery('#'+barId);
                let curR = bar.attr("row");
                let t,b;
                let rows = this.layout.tableData.length;
                for(let i = 0 ; i < rows ; i++){
                    t = i* this.props.cellHeight+topMargin;
                    b = t+ this.props.cellHeight;
                    if(y<=b-5 && y>=t){
                        return i;
                    }

                }
                return curR;
ß
            }
            ,getRowNumberOfBar(barid){
                return jQuery("#"+barid).attr("row");
            }
            ,getBarsInRow(rowNumber){
                let bars=[]
                jQuery(".ganttview-block").each(function(){
                    if( jQuery(this).attr("row")==rowNumber){
                        bars.push(jQuery(this));
                    }

                });
                return bars;
            }
            ,getBarsDataInRow(rowNumber){
                let bars = this.getBarsInRow(rowNumber);
                let barDatas =[];
                (bars||[]).forEach(function(item,index){
                        barDatas.push(gantt.getDataByBarId(item.attr("id")));
                });
                return barDatas;

            }
            ,getPreNearBarJQuery( barid){
                let curData = this.getDataByBarId(barid);
                let bars = this.getPreBarsJQuery();
                let near=null;

                bars.forEach(function(bar,i){
                    if(near==null){
                        near = bar;
                    }
                    if(near.end <=curData.start){
                        if (near.end<bar.end){
                            near = bar;
                        }
                    }

                });
                return near;
            }
            ,getNextNearBarJQuery( barid){
                let curData = this.getDataByBarId(barid);
                let bars = this.getNextBarsJQuery();
                let near=null;

                bars.forEach(function(bar,i){
                    if(near==null){
                        near = bar;
                    }
                    if(near.start >=curData.end){
                        if (near.start<bar.start){
                            near = bar;
                        }
                    }

                });
                return near;
            }
            ,getPreBarsJQuery( barid ){

                let barData = this.getDataByBarId(barid);
                let bars = this.getBarsInRow( this.getRowNumberOfBar(barid));
                let pres=[];
                let d;

                (bars||[]).forEach(function(b,i){
                    d=gantt.getDataByBarId(b.attr("id"));
                   if (d.start<barData.start) {
                       pres.push( b );
                   }
                });
                return pres;
                // return prev = jQuery(this).prev()[0] ? jQuery(jQuery(this).prev()[
                //      0]) : null;
            }
            ,getNextBarsJQuery( barid ){

                let barData = this.getDataByBarId(barid);
                let bars = this.getBarsInRow( this.getRowNumberOfBar(barid));
                let nexts=[];
                let d;

                (bars||[]).forEach(function(b,i){
                    d=gantt.getDataByBarId(b.attr("id"));
                    if (d.start > barData.end ) {
                        nexts.push( b );
                    }
                });
                return nexts;
                // return next = jQuery(this).next()[0] ? jQuery(jQuery(this).next()[
                //      0]) : null;
            }
            ,getBarId(bar){
                return bar.attr("id");
            }
            ,getDataIdByBarId(barid){
                if ( typeof barid == 'undefined'){
                    return NaN;
                }
                let pos = barid.indexOf(barid,"bar_");
                if(pos<0){
                    return NaN;
                }
                return barid.substr(pos+4);
            }
            ,getDataByBarId(barid){
                if((gantt.datas || []).length<=0){
                    return {};
                }
                let id = this.getDataIdByBarId(barid);
                return this.getDataById(id);
            }
            ,getDataById(dataId){
                var d={};
                if ( typeof dataId == 'undefined'){
                    return d;
                }
                this.datas.forEach(function (item , index){
                    (item.series || []).forEach(function( data,idx){
                        if ( data.id==dataId){
                            d = data;
                            return;
                        }
                    });
                    if(d.id){
                        return;
                    }

                });
                return d;
            }
            ,barId(id) {
                return 'bar_'+id;
            }
            ,gridRowId(i){
                return 'grow_'+i;
            }
            ,gridColId(r,c){
                return 'grow_'+r+"__gcol_"+c;
            }
            ,rowId(i){
                return 'row_'+i;
            }
            ,colId(i){
                return 'row_'+r+"__col_"+c;
            }
            ,renderVHeader(){
                //需要调用重绘 main 和 blocks
                jQuery(".ganttview-vtheader").empty();
                let dhtml = '';
                let self = this;
                dhtml = dhtml +'<div class="ganttview-vtheader-content">' +
                    '<table class="ganttview-vtheader-item">' +
                    '<thead>';
                self.layout.tableDataType.forEach(function(item,index){
                    if ( item.hidden!=true) {
                        dhtml = dhtml + '<th class="ganttview-vtheader-title ganttview-vtheader-title-name" style="height:'+self.props.headerHeight+'px">' + item.label + '</th>';
                    }
                });
                dhtml = dhtml+'</thead>';
                dhtml = dhtml+'<tbody>';
                self.layout.tableData.forEach(function(row,ridx){
                    dhtml = dhtml+'<tr class="ganttview-vtheader-series" id="'+ row.attr.id+ '" _key="'+row.attr.key+'">';
                        self.layout.tableDataType.forEach(function(col,cidx){
                            if(col.hidden!=true) {
                                dhtml = dhtml + '<td class="ganttview-vtheader-series-name">'+row[col.name]+'</td>'
                            }
                        });
                    dhtml = dhtml+'</tr>'
                });
                dhtml = dhtml+'</tbody>';
                dhtml = dhtml+'</div>';

                $(".ganttview-vtheader").append($(dhtml));

            }
            ,renderMain(){
                let dhtml = '';
                 jQuery(".ganttview-main").empty();
                self = this;
                console.log('props.start:'+self.props.start.format('YYYY-MM-DD HH:mm')+" end:"+'props.start:'+self.props.end.format('YYYY-MM-DD HH:mm')+' self.hzheaderTotalWidth:'+self.hzheaderTotalWidth() );
                dhtml = dhtml+'<div class="ganttview-hint"> <div class="ganttview-hint-content">Hints</div></div>';
                //<!-- 左半边日期项目条 -->
                dhtml = dhtml+'<div class="ganttview-slide">';
                    dhtml = dhtml+'<div class="ganttview-slide-container">';
                    //<!-- 日期和小时部分块 -->
                        dhtml = dhtml+'<div class="ganttview-hzheader" style="width:'+self.hzheaderTotalWidth()+'px" >';
                            dhtml = dhtml+'<div class="ganttview-hzheader-months">';
                            self.dateDiff().forEach(function(day,index){
                                    dhtml=dhtml+'<div class="ganttview-hzheader-month" style="width:'+self.getHzHeaderMonthWith(self.props.start.clone().add(index,'d'))+'px">'+day+'</div>'
                                });
                            dhtml=dhtml+'</div>';

                            dhtml = dhtml+'<div class="ganttview-hzheader-days">';
                            self.hourList().forEach(function(hour,index){
                                    dhtml = dhtml+'<div class="ganttview-hzheader-day">'+hour+'</div>';
                                });
                            dhtml = dhtml+'</div>';
                        dhtml = dhtml+'</div>';
                        dhtml = dhtml+'<div style="clear: both;"></div>';
                        //<!-- 网格部分 -->
                        dhtml = dhtml+'<div class="ganttview-grid" style="width:'+this.hzheaderTotalWidth()+'px">';
                            this.layout.tableData.forEach(function(item , ridx){
                                dhtml = dhtml+'<div class="ganttview-grid-row" id="'+self.gridRowId(ridx)+'">';
                                self.hourList().forEach(function(hour,cidx){
                                    dhtml = dhtml + '<div class="ganttview-grid-row-cell" ';
                                        if ( hour == 0 ){
                                            dhtml = dhtml+'class="ganttview-weekend"';
                                        }
                                        dhtml = dhtml+' id="'+self.gridColId(ridx,cidx)+'">';


                                    dhtml = dhtml+'</div>';
                                });

                                dhtml = dhtml+'</div>';
                            });

                        dhtml = dhtml+'</div>';

                        //<!-- 可操作的容器块部分 -->
                        dhtml = dhtml+'<div class="ganttview-blocks" >' +
                            '<div class="arrow"></div>' +
                            '<div class="arrow-hints">time hints</div>' +
                            '<div class="ganttview-block-hint"></div>' +
                            '<div class="ganttview-block-hint-start"></div>' +
                            '<div class="ganttview-block-hint-end"></div>' +
                            ' <!-- 调用renderBlocks 绘制-->';
                        dhtml = dhtml+'</div>';

                    dhtml = dhtml+'</div>';
                dhtml = dhtml+'</div>';


                $(".ganttview-main").append($(dhtml));


            }
            ,bindBarSelect(){
                console.log('bindBarSelect');
                let rows =[]
                this.allRow.forEach(function ( row,index){
                    row.series.forEach(function(d,dindex){
                        let r = {};
                        r.id = d.id;
                        r.text = d.name;
                        rows.push(r);
                    });

                });
                jQuery("#barSelector").select2({
                    data: rows,
                    placeholder:'请选择...',
                    allowClear:true
                });
                jQuery('#barSelector').val("").select2();
            }
            ,htmlBlockData(data){
                let dhtml ='';
                let row = this.getRowOfData(data);
                let self = this;
                dhtml = dhtml + '<div class="ganttview-block ganttview-block-deactive';
                if ( (data.progress || 0 )>=100){
                    dhtml = dhtml+' ganttview-block-freeze';
                }
                dhtml = dhtml+'" ';
                dhtml = dhtml + ' id="' + self.barId(data.id) + '" ';
                dhtml = dhtml + ' _key="' + data.key + '" ';
                dhtml = dhtml + ' style="position: absolute'
                    + ';z-index:10'
                    + ';top:' + self.calTop(data) + 'px'
                    + ';width:' + self.calBlockWidth(data) + 'px'
                    //+ ';background-color:' + self.randomColor()
                    + ';left:' + self.calLeft(data) + 'px'
                    + ';margin-top:'+ (self.props.rowHeight - self.props.barHeight) + 'px'
                    + ';height:' + self.props.barHeight + 'px'
                    + '"';
                dhtml = dhtml + ' row="' + row + '" >';
                dhtml = dhtml + '<div class="ganttview-block-text">'+data.name+'</div>';
                dhtml = dhtml + '<div class="ganttview-block-progress" style="width:'+(data.progress || 0)+'%">'+(data.progress || 0)+'%</div>';
                dhtml = dhtml + '</div>';

                return dhtml;

            }
            ,renderBlocks(){
                //防止 v-for 出现数据绑定
                jQuery(".ganttview-blocks").remove((".ganttview-block"));


                let dhtml='';
                let irs = 0;
                self = this;

                this.allRow.forEach(function(row,rindex){
                    row.series.forEach(function(item,index) {
                        dhtml = dhtml+ self.htmlBlockData(item)
                        // dhtml = dhtml + '<div class="ganttview-block ganttview-block-deactive';
                        // if ( (item.progress || 0 )>=100){
                        //     dhtml = dhtml+' ganttview-block-freeze';
                        // }
                        // dhtml = dhtml+'" ';
                        // dhtml = dhtml + ' id="' + self.barId(item.id) + '" ';
                        // dhtml = dhtml + ' _key="' + row.key + '" ';
                        // dhtml = dhtml + ' style="position: absolute'
                        //     + ';z-index:10'
                        //     + ';top:' + self.calTop(item) + 'px'
                        //     + ';width:' + self.calBlockWidth(item) + 'px'
                        //     //+ ';background-color:' + self.randomColor()
                        //     + ';left:' + self.calLeft(item) + 'px'
                        //     + ';margin-top:'+ (self.props.rowHeight - self.props.barHeight) + 'px'
                        //     + ';height:' + self.props.barHeight + 'px'
                        //     + '"';
                        // dhtml = dhtml + ' row="' + self.getRowOfData(item) + '" >';
                        // dhtml = dhtml + '<div class="ganttview-block-text">'+item.name+'</div>';
                        // dhtml = dhtml + '<div class="ganttview-block-progress" style="width:'+(item.progress || 0)+'%">'+(item.progress || 0)+'%</div>';
                        // dhtml = dhtml + '</div>';
                        irs = irs + 1;

                    });
                });
                console.log(' allrows:'+ irs );
                $(".ganttview-blocks").append($(dhtml));
                let rows =[]
                this.allRow.forEach(function ( row,index){
                    row.series.forEach(function(d,dindex){
                        let r = {};
                        r.id = d.id;
                        r.text = d.name;
                        rows.push(r);
                    });

                });

                jQuery("#barSelector").select2({
                    data: rows,
                    placeholder:'请选择...',
                    allowClear:true
                });
                jQuery('#barSelector').val("").select2();
                jQuery('#barSelector').on('select2:select', function (e) {
                    console.log("select");
                    var data = e.params.data;
                    gantt.activeBar(gantt.barId(data.id));

                    gantt.topBar(gantt.barId(data.id));
                    gantt.focusBar( gantt.barId(data.id) );
                });



            }
            ,adjustBlocksPosition(){
                let h = jQuery(".ganttview-slide-container")[0].scrollHeight;
                jQuery(".ganttview-hint").height((h )+'px');
                jQuery(".ganttview-vtheader").height((h )+'px');

                jQuery(".ganttview-blocks").height((h-this.props.headerHeight)+'px');

                let w = jQuery(".ganttview-slide-container")[0].scrollWidth;
                jQuery(".ganttview-blocks").width((w)+'px');
            }
            ,extendArrow(){
                jQuery.extend({
                    arrowFlowDrag:function(barid,clickX,clickY){
                        let bar =  jQuery("#"+barid);
                        let arw =  jQuery("div.arrow");

                        let row = parseInt(bar.attr("row") );
                        isUp = 1;
                        rowcount = gantt.layout.tableData.length;

                        isUp = 1;
                        arw.removeClass("arrowDown");
                        arw.addClass("arrowUp");


                        let top = parseInt( bar.css("top") );
                        let left = parseInt( bar.css("left"));
                        let height = bar.height;

                        y = top-5;
                        x = left + clickX-3;
                        if(isUp==0){
                            y = top+height+5;
                        }


                        arw.css("top",y);
                        arw.css("left",x);

                        if(gantt.props.showDragHints) {
                            arw.css("display", "block");
                            let arw_hint = jQuery("div.arrow-hints");
                            arw_hint.css("top", y+5);
                            arw_hint.css("left", x + 10);
                            arw_hint.css("display", "block");
                        }



                    }
                    ,showBlockStartEndHints(barid){
                        let bar =  jQuery("#"+barid);
                        let hintStart =  jQuery("div.ganttview-block-hint-start");
                        let hintEnd =  jQuery("div.ganttview-block-hint-end");

                        let top = parseInt( bar.css("top") );
                        let left = parseInt( bar.css("left"));
                        let width = bar.width();
                        let y;

                        y = top-hintStart.height()-5;//gantt.props.cellHeight;

                        let row = parseInt(bar.attr("row") );
                        // if(row <=0){
                        //     y = top+gantt.props.cellHeight+5;
                        // }
                        hintStart.css("top",y);
                        hintEnd.css("top",y);

                        hintEnd.css("left",left+bar.width()+5 );
                        hintStart.css("left",left-hintStart.width()-5);

                        hintStart.css("display", "block");
                        hintEnd.css("display", "block");
                        gantt.updateBarEndHints(barid)
                        gantt.updateBarStartHints(barid)

                    }
                });

            }
            ,extendHints(){

                jQuery(".ganttview-block").each(function(item){
                    let bar = jQuery(this);

                    let hint = jQuery(".ganttview-block-hint");
                    bar.mouseover(function (e) {

                        // let barData = gantt.getDataByBarId(bar.attr("id"));
                        let txt = gantt.getBarHints(bar.attr("id"));

                        let left = parseInt(bar.css("left"));
                        let top = parseInt(bar.css("top"));
                        hint.css("left", (left+e.offsetX+15)+'px');
                        hint.css("top", (top + gantt.props.cellHeight)+'px');
                        hint.text(txt);

                        hint.show();
                    })
                        .mouseout(function () {
                            // jQuery(".ganttview-block-hint").css("display","none");
                            hint.hide();

                        })
                        .mousemove(function (e) {

                            let left = parseInt(bar.css("left"));
                            let top = parseInt(bar.css("top"));
                            let rn  = gantt.getRowNumberOfBar(bar.attr("id"));
                            let rns = gantt.layout.tableData.length;
                            let ds = gantt.props.cellHeight;

                            if( rn >=rns-1){
                                ds = -gantt.props.cellHeight-8;
                            }


                            hint.css("left", (left+e.offsetX+15)+'px');
                            hint.css("top", (top + ds)+'px');
                        });
                });

                jQuery('div.ganttview-hint').mousedown( function ( e){
                    let st = jQuery('div.ganttview-hint').attr("_width") || '220';
                    let wd = parseInt(st);
                    if(e.offsetX<=5){
                        if(wd<=5){
                            wd = 220;

                            jQuery('div.ganttview-hint-content').css("display","block");
                        }
                        else{
                            wd = 5;
                            jQuery('div.ganttview-hint-content').css("display","none");
                        }

                    }
                    jQuery('div.ganttview-hint').attr("_width" , wd);
                    jQuery('div.ganttview-hint').css("width",wd+'px');


                });
                jQuery('div.ganttview-hint').mousemove(function (e){
                    let cursor ;
                    if(e.offsetX<=5){
                        jQuery('div.ganttview-hint').css("cursor","pointer");
                    }
                    else{
                        jQuery('div.ganttview-hint').css("cursor","default");
                    }
                });
            }
            ,bindNavButton(){

                $(".nav-button").click(function(event){
                    let self = $(this);
                    let id = self.attr("id");
                    if( typeof gantt.props.onButtonClick == 'function'){
                        if ( self.attr("id") =='btnMulti'){
                            let cls = 'unselected';
                            if(self.hasClass("unselected")){
                                cls="selected";
                            }
                            if(cls=='selected'){
                                self.removeClass("unselected");
                                self.attr("title",'多选');
                                gantt.props.selectstatus="multi";
                            }
                            else{
                                self.removeClass("selected");
                                self.attr("title",'单选');
                                gantt.props.selectstatus="single";
                            }

                            self.addClass(cls);
                            if( gantt.props.selectstatus=="single"){

                                gantt.deactiveAllBars();
                            }

                        }
                        if ( self.attr("id") =='btnMagnet'){
                            let barsid = gantt.getSelectedBarsId();

                            for(let j = 0 ; j < barsid.length ; j++){
                                gantt.magnetBars( barsid[j],barsid[j+1]);
                            }

                        }
                        if( id=='btnNew'){
                            //call outside new panel , create new data
                            let data = gantt.props.newData();
                            if(!data){
                                return;
                            }
                            if(!data.id || !data.key || !data.start || !data.end ){
                                return;
                            }
                            gantt.insertData(data);

                        }
                        if( id == 'btnDelete'){
                            let barsid = gantt.getSelectedBarsId();
                            if(!barsid || barsid.length<=0){
                                return;
                            }
                            for(let i =0 ; i < barsid.length; i++){
                                gantt.deleteBar(barsid[i]);
                            }

                        }
                        if( id == 'btnSplit'){
                            let barsid = gantt.getSelectedBarsId();
                            if(!barsid || barsid.length<=0){
                                return;
                            }
                            let datas = gantt.props.getSplitDatas(barsid[0],gantt.getDataByBarId(barsid[0] ));
                            if(!datas || datas.length<=1){
                                return;
                            }
                            gantt.splitBar(barsid[0],datas[0],datas[1]);

                        }
                        if(id=='btnMerge'){
                            // alert( '测试手动改变数据 ，重绘bar');
                            // let data = gantt.datas[0].series[0];
                            // let newData = {};
                            // newData.id = data.id;
                            // newData.key = data.key;
                            // newData.start = data.start.clone().add(1,'hours');
                            // newData.end = data.end.clone();
                            // newData.key = 'bma1';
                            // newData.progress=gantt.getNumber(Math.random()*100 , 2);
                            // gantt.changeBarByManual(newData);
                            let barsid = gantt.getSelectedBarsId();
                            if(!barsid || barsid.length<=1){
                                return;
                            }
                            let fbarid = barsid[0];
                            for(let i = 1 ; i < barsid.length; i++){
                                gantt.mergeBar(fbarid,barsid[i]);
                            }

                        }

                        if( id == 'btnPrev' ){
                            gantt.props.start = gantt.props.start.subtract( gantt.props.extendTimes,'d');
                            gantt.expendTimeRender();
                            // gantt.adjustBlocksPosition();
                        }
                        if( id == 'btnNext' ){
                            gantt.props.end = gantt.props.end.add( gantt.props.extendTimes,'d');
                            gantt.expendTimeRender();
                        }

                        gantt.props.onButtonClick(self.attr("id"));
                    }

                })

            }
            ,extendVHeader(){

                jQuery('div.ganttview-vtheader').mousedown( function ( e){
                    let self = jQuery(this) ;
                    let st = jQuery('div.ganttview-vtheader').attr("_width") || '240';
                    let wd = parseInt(st);
                    st = wd;
                    if(e.offsetX>=(self.width()-5) ){
                        if(wd<=5){
                            wd = 240;

                            jQuery('div.ganttview-vtheader-content').css("display","block");
                        }
                        else{
                            wd = 5;
                            jQuery('div.ganttview-vtheader-content').css("display","none");
                        }

                    }
                    jQuery('div.ganttview-vtheader').attr("_width" , wd);
                    jQuery('div.ganttview-vtheader').css("width",wd+'px');

                });
                jQuery('div.ganttview-vtheader').mousemove(function (e){
                    let self = jQuery(this) ;
                    if(e.offsetX>=(self.width()-5) ){
                        jQuery('div.ganttview-vtheader').css("cursor","pointer");
                    }
                    else{
                        jQuery('div.ganttview-vtheader').css("cursor","default");
                    }
                });

            }
            ,expendTimeRender(){
                this.renderMain();
                this.renderBlocks();
                //可以带一个回调函数参数
                this.bindBlockResize();
                this.bindBlockDrag();
                this.bindToolTip();
                this.bindBlockClick();
                this.bindViewClick();
                // 设置 bar-blocks 的长宽
                this.adjustBlocksPosition();
                // 设置拖动的箭头
                this.extendArrow();
                //提示框
                this.extendHints();
            }

            ,initBind() {
                this.renderVHeader();
                this.renderMain();
                this.renderBlocks();
                //可以带一个回调函数参数
                this.bindBlockResize();
                this.bindBlockDrag();
                this.bindToolTip();
                this.bindBlockClick();
                this.bindViewClick();

                // 设置 bar-blocks 的长宽
                this.adjustBlocksPosition();

                // 设置拖动的箭头
                this.extendArrow();

                //提示框
                this.extendHints();
                this.bindNavButton();
                this.extendVHeader();




            },
            //计算block的width
            calBlockWidth(data) {
                return data.end.diff(data.start, 'h', true) * this.props.cellWidth
            },
            //计算block的margin-left
            calLeft(data) {
                let _x = this.getNumber(this.props.start.minute()/60,2)*this.props.cellWidth;
                return  Math.round(_x)+data.start.diff(this.props.start, 'h', true) * this.props.cellWidth ;//+ this.props.vtheaderWidth + this.props.leftPadding;
            }
            ,getRowOfData(data){
                for(let i = 0 ; i < this.layout.tableData.length;i++){
                    if(data.key == this.layout.tableData[i].attr["key"]){
                        return i;
                    }
                }
                return undefined;
            }
            ,calTop(data){
                let rows = this.layout.tableData.length;
                let r;
                for(let rownumber = 0 ; rownumber < rows ; rownumber++){
                    r=this.layout.tableData[rownumber];
                    if(r.attr["key"]==data.key){
                        return rownumber * this.props.cellHeight ;//+ this.props.hzheaderHeight+ this.props.topPadding;
                    }
                };
                return NaN;

            },
            //test
            calLeftRandom(data) {
                let w = this.calBlockWidth(data)
                return (data.start.diff(this.props.start, 'h', true) *
                    this.props.cellWidth) + w + (parseInt((Math.random() * (0 -
                    100) + 100)
                    .toFixed(
                        0)))
            },
            //随机颜色
            randomColor() {
                return '#' + (~~(Math.random() * (1 << 24))).toString(16)
            },
            //计算ganttganttview-slide-container容器的宽度
            resizeWidth() {
                let ganttViewW = $('.ganttview').innerWidth();
                let ganttVtHeaderW = $('.ganttview-vtheader').outerWidth();
                $('.ganttview-slide-container').outerWidth(ganttViewW -
                    ganttVtHeaderW)
            },
            //计算每天的MM/DD的block长度
            getHzHeaderMonthWith(date) {
                let width;
                if (date.format("MM/DD") == this.props.start.format("MM/DD")) {
                    width = (24 - (this.props.start.hour() + 0)) * this.props.cellWidth;
                } else if (date.format("MM/DD") == this.props.end.format(
                    "MM/DD")) {
                    width = (this.props.end.hour() + 1) * this.props.cellWidth
                } else {
                    width = 24 * this.props.cellWidth
                }
                return width - 1
            },
            //以下绑定事件
            bindBlockResize(callback) {
                let borderSize = 2;
                let prev; //前一个兄弟节点
                let next; //后一个兄弟节点
                let self; //自身
                //记录碰撞时的最大width
                let maxWidth = null;
                let hitLeft = false
                //锁定碰撞时的数据
                let lock = false;
                let maxLeftMargin = null; //null代表不限制
                let minLeftMargin = null;
                let startPos={ //开始位置
                    x:0
                    ,y:0
                    ,h:0
                    ,w:0
                    ,state:0
                };
                let endPos={ //结束位置
                    x:0
                    ,y:0
                    ,h:0
                    ,w:0
                    ,state:0
                };

                jQuery("div.ganttview-block").resizable({
                    handles: "e,w",
                     // containment: 'parent',
                    start() {

                        self = jQuery(this);

                        if(!gantt.props.canResize( self.attr("id"))){
                            event.preventDefault();
                            maxWidth=parseInt( self.css("width"));
                            self.css("max-width",parseInt( self.css("width"))+'px');

                            self.css("min-width",parseInt( self.css("width"))+'px');
                            return;
                        }
                        else{

                            self.css("max-width",'');
                            self.css("min-width",'');
                        }


                        let data = gantt.getDataByBarId( self.attr("id"));
                        data._original={};
                        data._original.start = moment(data.start.valueOf());
                        data._original.end = moment(data.end.valueOf());
                        if(gantt.props.selectstatus=='multi'){
                            gantt.deactiveAllBars();
                        }
                        gantt.activeBar( self.attr("id") );
                        gantt.topBar(self.attr("id"));
                        // prev = jQuery(this).prev()[0] ? jQuery(jQuery(this).prev()[
                        //     0]) : null;
                        prev = gantt.getPreNearBarJQuery(self.attr("id"));
                        // next = jQuery(this).next()[0] ? jQuery(jQuery(this).next()[
                        //     0]) : null;
                        next = gantt.getNextNearBarJQuery(self.attr("id"));

                        startPos.x = self.css("left");
                        startPos.y = self.css("top");
                        startPos.h = self.css("height");

                        startPos.w = self.css("width");
                        startPos.state = 1;
                        endPos.state = 0;
                        if (prev) {
                            let pleft = parseFloat(prev.css("left")) || 0;
                            let pTwidth = parseFloat(prev.width()) + borderSize;
                            minLeftMargin = pleft + pTwidth
                        } else {
                            minLeftMargin = null;
                        }
                        if (next) {
                            let nleft = parseFloat(next.css("left")) || 0;
                            maxLeftMargin = nleft;
                        } else {
                            maxLeftMargin = null;
                        }

                        if( typeof gantt.props.onItemStartResize =='function'){
                            gantt.props.onItemStartResize(self.attr("id"),startPos,endPos);
                        }
                    },
                    resize(event, ui) {
                        self = jQuery(this);
                        if(!gantt.props.canResize( self.attr("id"))){
                            event.preventDefault();

                            return;
                        }
                        else{
                            self.css("max-width", '');
                        }

                        gantt.activeBar( self.attr("id") );
                        let {
                            left = 0
                        } = ui.position;
                        let {
                            width
                        } = ui.size;
                        let hit = false;

                        if (minLeftMargin) {
                            if (left < minLeftMargin) {
                                console.log('left hit');
                                hit = true;
                                hitLeft = true;
                            }
                        }
                        if (maxLeftMargin) { //计算右边是否碰撞
                            if ((left + width + borderSize) > maxLeftMargin) {
                                console.log('right hit');
                                hit = true;
                                hitLeft = false;
                            }
                        }
                        if (hit) {
                            if (!lock) {
                                if (hitLeft) {
                                    maxWidth = ui.originalPosition.left + ui.originalSize
                                        .width - minLeftMargin;
                                } else {
                                    maxWidth = maxLeftMargin - ui.originalPosition.left -
                                        borderSize
                                }
                                lock = true;
                            }
                            //修正左缩放的位置
                            if (hitLeft) {
                                let fixRight = minLeftMargin - left;
                                self.css("margin-left", fixRight)
                            }
                            event.preventDefault();
                            //TOFIXED：固定最大宽度，因为event.preventDefault()不起暂停作用
                            self.css("max-width", maxWidth)
                        } else {
                            //重置修正
                            self.css('max-width', '');
                            self.css("margin-left", "");
                            maxWidth = null;
                            lock = false;
                        }
                        endPos.x = self.css("left");
                        endPos.y = self.css("top");
                        endPos.h = self.css("height");
                        endPos.w = self.css("width");
                        endPos.state = 1;
                        let ew = 'left';
                        if ( ui.position.left == ui.originalPosition.left){
                            ew='right'
                        }
                        if( typeof gantt.props.onItemResize =='function'){
                            gantt.props.onItemResize(self.attr("id"),startPos,endPos , ui , ew);
                        }
                        gantt.resizeBarDate(self.attr("id"),startPos,endPos,ew);
                        jQuery.showBlockStartEndHints(self.attr("id") );
                        gantt.updateBarHints( self.attr("id") );
                    },
                    stop() {
                        if (maxWidth) {
                            self.width(maxWidth);
                            if (hitLeft) {
                                self.css("left", minLeftMargin)
                            }

                        }
                        jQuery(".ganttview-block-hint-start").css("display","none");
                        jQuery(".ganttview-block-hint-end").css("display","none");

                        //重置修正
                        self.css('max-width', '');
                        self.css("margin-left", "");
                        maxWidth = null;
                        lock = false;
                        if( typeof gantt.props.onItemEndResize =='function'){
                            gantt.props.onItemEndResize(self.attr("id"),startPos,endPos);
                        }
                        if (callback) {
                            callback(self)
                        }
                    }
                });
            },

            bindBlockDrag(callback) {

                let borderSize = 2;
                let prev; //前一个兄弟节点
                let next; //后一个兄弟节点
                let self; //自身
                let maxLeftMargin = 0; //-1值代表不限制
                let minLeftMargin = 0;
                let startPos={ //开始位置
                    x:0
                    ,y:0
                    ,h:0
                    ,w:0
                    ,state:0
                };
                let dragPos={ //拖动时位置
                    x:0
                    ,y:0
                    ,h:0
                    ,w:0
                    ,state:0
                };
                let arrowX;
                let arrowY;
                let arrowDate;

                jQuery("div.ganttview-block").draggable({
                    // axis: "x",
                    scroll: true,
                    distance: 10,
                    containment: 'parent',
                    grid:[1,32],
                    start(event , ui) {
                         self = jQuery(this);
                         if(!gantt.props.canDrag( self.attr("id"))){
                             event.preventDefault();
                             return;
                         }
                        if(gantt.props.selectstatus=='multi'){
                            gantt.deactiveAllBars();
                        }
                        gantt.topBar(self.attr("id"));

                        gantt.activeBar( self.attr("id") );

                        let e = event || window.event;
                        let x = e.offsetX || e.originalEvent.layerX;
                        let y = e.offsetY || e.originalEvent.layerY;

                        arrowX=x;
                        arrowY = y;
                        jQuery.arrowFlowDrag(self.attr("id"),arrowX,arrowY);


                        prev = gantt.getPreNearBarJQuery(self.attr("id"));
                        prev = gantt.getNextNearBarJQuery(self.attr("id"));
                        self = jQuery(this);
                        startPos.x = self.css("left");
                        startPos.y = self.css("top");
                        startPos.h = self.css("height");
                        startPos.w = self.css("width");
                        startPos.state = 1;
                        dragPos.state = 0;
                        let data = gantt.getDataByBarId( self.attr("id"));
                        data._original={};
                        data._original.start = moment(data.start.valueOf());
                        data._original.end = moment(data.end.valueOf());

                        if (prev) {
                            let pleft = parseFloat(prev.css("left")) || 0;
                            let pTwidth = parseFloat(prev.width()) + borderSize;
                            minLeftMargin = pleft + pTwidth
                        } else {
                            minLeftMargin = null;
                        }
                        if (next) {
                            let nleft = parseFloat(next.css("left")) || 0;
                            maxLeftMargin = nleft;
                        } else {
                            maxLeftMargin = null;
                        }
                        if( typeof gantt.props.onItemStartDrag =='function'){
                            gantt.props.onItemStartDrag(self.attr("id"),startPos,dragPos,arrowX,arrowY);
                        }

                    },
                    drag(event, ui) {


                        if(!gantt.props.canDrag( self.attr("id"))){
                            event.preventDefault();
                            return;
                        }
                        //self = jQuery(this);
                        let curR=parseInt( self.attr('row'));
                        gantt.activeBar( self.attr("id") );

                        let {
                            left = 0
                        } = ui.position;


                        jQuery.arrowFlowDrag(self.attr("id"),arrowX,arrowY);



                        let width = self.width();
                        let hit = false;
                        let hitLeft = false;


                        //计算左边是否碰撞
                        if (minLeftMargin) {
                            if (left < minLeftMargin) {
                                console.log('left hit');
                                hit = true;
                                hitLeft = true;
                            }
                        }
                        //计算右边是否碰撞
                        if (maxLeftMargin) {
                            if ((left + width + borderSize) > maxLeftMargin) {
                                console.log('right hit');
                                hit = true;
                            }
                        }
                        if (hit) {
                            event.preventDefault();
                            //因为获取的left不准，需要手动修正
                            let fixLeft;
                            if (hitLeft) {
                                fixLeft = minLeftMargin
                            } else {
                                fixLeft = maxLeftMargin - width - borderSize
                            }
                            self.css("left", fixLeft)
                        }

                        let direct = "left";
                        let cX = parseInt( self.css("left"));
                        if(parseInt(startPos.x)<parseInt( cX ) ){
                            direct = "right";
                        }

                        dragPos.x = self.css("left");
                        dragPos.y = self.css("top");
                        dragPos.h = self.css("height");
                        dragPos.w = self.css("width");
                        dragPos.state = 1;



                        let data = gantt.getDataByBarId(self.attr("id") );
                         gantt.dragBarDate( self.attr("id") , startPos,dragPos);

                        arrowDate = gantt.getDragTime(self.attr("id"),startPos,dragPos ,arrowX,arrowY);

                        jQuery(".arrow-hints").html(moment(arrowDate).format("YYYY-MM-DD HH:mm"));

                        let r = gantt.rowInXY(self.attr("id"),parseInt( dragPos.x) , parseInt( dragPos.y) );
                        if(r!=curR) {
                            self.attr("row", r);
                            let key = gantt.getKeyOfRow(r);

                            self.attr("_key", key);
                            let data = gantt.getDataByBarId(self.attr("id"));
                            data.key = key;

                            gantt.moveDataByKey(data, key);

                        }

                        gantt.updateBarHints(self.attr("id"));
                        jQuery.showBlockStartEndHints(self.attr("id"));

                        if( typeof gantt.props.onItemDrag =='function'){
                            gantt.props.onItemDrag(self.attr("id"),startPos,dragPos , arrowDate);
                        }

                    },
                    stop(event , ui) {

                        //var tt = jQuery(this);
                        jQuery("div.arrow").css("display","none");
                        jQuery("div.arrow-hints").css("display","none");
                        jQuery("div.ganttview-block-hint-start").css("display","none");
                        jQuery("div.ganttview-block-hint-end").css("display","none");

                        let barId = self.attr("id");
                        let data =  gantt.getDataByBarId(self.attr("id")) ;
                        let dataJson=JSON.stringify( data );


                        // console.log("drag stop barId:"+barId+" startPos:"+JSON.stringify(startPos)+" dragPos:"+JSON.stringify(dragPos));
                        if( typeof gantt.props.onItemEndDrag =='function'){
                            gantt.props.onItemEndDrag(self.attr("id"),startPos,dragPos,arrowDate);
                        }
                        if (callback) {
                            callback(self)
                        }
                    }
                });
            },
            bindViewClick(callback){
                jQuery("div.ganttview-blocks").on("dblclick", function (event ) {
                    self = jQuery(this);

                    if( typeof gantt.props.onViewClick =='function'){
                        gantt.props.onViewClick(self,event);
                    }
                    if (callback) {
                        callback(self)
                    }
                });
            }
            ,bindBlockClick(callback) {
                jQuery("div.ganttview-block").on("click", function (event,ui) {
                    self = jQuery(this);
                    let e = event || window.event;
                    let x = e.offsetX || e.originalEvent.layerX;
                    let y = e.offsetY || e.originalEvent.layerY;


                    gantt.activeBar( self.attr("id") );
                    gantt.topBar(self.attr("id"));

                    event.stopPropagation();


                });
                jQuery("div.ganttview-block").on("dblclick", function (event) {
                    self = jQuery(this);

                    gantt.activeBar( self.attr("id") );
                    gantt.topBar(self.attr("id"));
                    if( typeof gantt.props.onItemClick =='function'){
                        gantt.props.onItemClick(self.attr("id"));
                    }
                    if (callback) {
                        callback(self)
                    }
                    event.stopPropagation();
                });
            },
            bindToolTip(div) {
                jQuery("div.ganttview-block").tooltip();
            },
        }

    }).$mount("#ganttChart");
</script>

</body>

</html>